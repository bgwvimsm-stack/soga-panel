# Soga Panel Server 开发进度（MariaDB 版）

> 目标：在 `server/` 下逐步复用/迁移 Worker 逻辑，完成自托管 MariaDB 版本。每完成一大类接口或基础设施，会更新状态。

## 基础设施
- [x] Node/Express 骨架（健康探针、数据库探针）
- [x] 环境变量校验（`src/config/env.ts`）
- [x] MariaDB 连接池（`src/config/db.ts`）
- [x] D1 兼容适配器（`src/db/d1-adapter.ts`，提供 `prepare().bind().all()/first()/run()` 和事务）
- [x] MariaDB Schema 翻译自 `worker/db/db.sql`（`server/db/schema.mysql.sql`）
- [x] 通用 DB 服务层（迁移 `DatabaseService` 到 Maria 版）
- [x] 缓存/会话方案（Maria 版 `CacheService`，Redis 优先，故障回退 MariaDB）
- [x] 日志/错误处理中间件

## 业务接口迁移路线（按大类）
- [x] 授权与账户：登录/注册/登出、OAuth、邮件验证码、2FA、密码重置（已接入登录/注册/登出、会话校验、用户资料、验证码/密码重置、邮件发送、2FA、OAuth通用登录）
- [x] 用户信息：个人资料、密码修改、可用节点、订阅 Token 重置、订阅日志、Bark、登录日志、在线设备/IP（已接通：个人资料、密码修改、可用节点、订阅 Token 重置、订阅/流量日志、Bark 设置、登录日志、在线 IP/设备）
- [x] 订阅输出：V2Ray/Clash/QuantumultX/Shadowrocket/Surge
- [x] Soga Node 接口：节点列表、用户列表、审计规则、白名单、流量/在线 IP/审计日志上报、节点状态上报
- [x] 商店与支付：套餐、优惠券、购买、钱包/充值、礼品卡、支付回调（Epay/Epusdt）（已接通：套餐列表/详情、创建套餐购买订单待支付、优惠券折扣校验/记录、购买记录查询、管理员订单/充值列表、钱包余额/充值记录、创建充值单与模拟回调入账、礼品卡兑换/管理、待处理充值列表与手动入账、Epay/Epusdt 回调联动充值与套餐支付、套餐支付成功自动激活并更新流量/等级、支付状态查询、管理员手动标记套餐支付、管理员创建并入账充值、优惠券更新接口、零元套餐自动激活、多类型礼品卡（余额/时长/流量/重置/套餐）、提现分页/审核拒绝返还、邀请返利自动发放、用户邀请码/邀请列表、返利流水/明细导出、余额支付套餐、钱包统计）
- [x] 流量统计：用户/系统流量趋势与汇总、手动更新、每日重置（已接通用户/系统流量查询、管理员系统流量概览、手动重置今日流量、每日汇总任务与手动汇总接口、system_traffic_summary 表、流量导出、节点状态/在线 IP 定期清理）
- [x] 公告：用户/管理员公告 CRUD（用户拉取、管理员新增/更新/删除、置顶/状态）
- [x] 工单：用户/管理员工单列表、详情、回复、状态更新（用户提交/回复、管理员列表/回复/变更状态）
- [x] 管理端：用户/节点 CRUD 与导出、系统配置、缓存管理、登录/订阅/审计日志、共享 ID、返利提现审核、测试数据生成（已接通：系统统计、用户列表/状态、缓存清理、登录/订阅/审计日志、节点列表/状态、配置管理、礼品卡管理、共享 ID 管理、返利划转/流水、用户导出 CSV、手动流量重置/预览、返利提现审核列表/待处理列表与状态更新、套餐销售统计、提现分页与拒绝返还、返利流水分页、流量导出、返利/订单/充值/流量 CSV 导出、管理路由归拢）
- [x] 定时任务：流量重置、用户等级过期、节点状态清理、订阅记录清理（Node 定时调度替代 Worker `scheduled`，含每日流量汇总）

## 预计开发顺序
1) 落库：MariaDB schema 翻译 + `DatabaseService` 适配器化。
2) 授权链路：登录/注册/登出 + 会话/Token 缓存，打通第一条完整业务链。（进行中：已完成登录/注册/登出、会话中间件、用户资料查询、邮件验证码/密码重置、邮件发送配置、2FA 启用/关闭与登录校验）
3) Soga Node 接口 + 用户订阅输出，确保节点联动与客户端可用。（订阅输出与 Node 接口已接通）
4) 商店/支付 + 钱包 + 返利提现 + 管理端。
5) 补全日志/监控与集成测试。

## 使用方式
- 每完成上述大类之一，会在本文件勾选并记录要点。
- 若需调整顺序或优先级，请在需求中说明，我会同步更新计划。
