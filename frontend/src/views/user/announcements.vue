<template>
  <div class="announcements-page">
    <!-- È°µÈù¢Â§¥ÈÉ® -->
    <div class="page-header">
      <h1 class="page-title">üì¢ ÂÖ¨ÂëäËØ¶ÊÉÖ</h1>
    </div>

    <!-- ÂÖ¨ÂëäÂàóË°® -->
    <div class="announcements-container">
      <div v-if="loading" class="loading-container">
        <el-skeleton :rows="3" animated />
      </div>

      <div v-else-if="error" class="error-container">
        <el-alert
          title="Âä†ËΩΩÂ§±Ë¥•"
          :description="error"
          type="error"
          :closable="false"
          center
        />
        <el-button @click="loadAnnouncements" type="primary" style="margin-top: 16px;">
          ÈáçËØï
        </el-button>
      </div>

      <div v-else-if="announcements.length === 0" class="empty-container">
        <el-empty description="ÊöÇÊó†ÂÖ¨Âëä">
          <el-button @click="loadAnnouncements" type="primary">Âà∑Êñ∞</el-button>
        </el-empty>
      </div>

      <div v-else class="announcements-list">
        <div
          v-for="announcement in announcements"
          :key="announcement.id"
          class="announcement-item"
          :class="`announcement-type-${announcement.type}`"
        >
          <!-- ÂÖ¨ÂëäÂ§¥ÈÉ® -->
          <div class="announcement-header">
            <div class="announcement-title-section">
              <span class="announcement-icon">
                <el-icon v-if="announcement.type === 'info'"><InfoFilled /></el-icon>
                <el-icon v-else-if="announcement.type === 'warning'"><WarningFilled /></el-icon>
                <el-icon v-else-if="announcement.type === 'success'"><SuccessFilled /></el-icon>
                <el-icon v-else-if="announcement.type === 'danger'"><CircleCloseFilled /></el-icon>
                <el-icon v-else><Bell /></el-icon>
              </span>
              <h2 class="announcement-title">{{ announcement.title }}</h2>
              <el-tag
                v-if="announcement.is_pinned"
                type="warning"
                size="small"
                class="pinned-tag"
              >
                ÁΩÆÈ°∂
              </el-tag>
            </div>
            <div class="announcement-meta">
              <span class="announcement-time">
                <el-icon><Clock /></el-icon>
                {{ formatTime(announcement.created_at) }}
              </span>
            </div>
          </div>

          <!-- ÂÖ¨ÂëäÂÜÖÂÆπ -->
          <div class="announcement-content">
            <div v-if="announcement.content_html" v-html="announcement.content_html"></div>
            <div v-else class="content-text">{{ announcement.content }}</div>
          </div>

          <!-- ÂÖ¨ÂëäÂ∫ïÈÉ®‰ø°ÊÅØ -->
          <div class="announcement-footer">
            <div class="announcement-info">
              <span v-if="announcement.created_by_name" class="author">
                ÂèëÂ∏ÉËÄÖ: {{ announcement.created_by_name }}
              </span>
              <span v-if="announcement.expires_at && !announcement.is_expired" class="expires">
                ÊúâÊïàÊúüËá≥: {{ formatTime(announcement.expires_at) }}
              </span>
              <span v-if="announcement.is_expired" class="expired-tag">
                <el-tag type="info" size="small">Â∑≤ËøáÊúü</el-tag>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Âä†ËΩΩÊõ¥Â§ö -->
      <div v-if="hasMore && !loading" class="load-more">
        <el-button @click="loadMore" :loading="loadingMore" type="primary" plain>
          Âä†ËΩΩÊõ¥Â§ö
        </el-button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { ElMessage } from 'element-plus';
import {
  InfoFilled,
  WarningFilled,
  SuccessFilled,
  CircleCloseFilled,
  Bell,
  Clock
} from '@element-plus/icons-vue';
import { getAnnouncements, type Announcement } from '@/api/announcement';

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const announcements = ref<Announcement[]>([]);
const loading = ref(false);
const loadingMore = ref(false);
const error = ref('');
const hasMore = ref(true);
const offset = ref(0);
const limit = 10;

// Âä†ËΩΩÂÖ¨ÂëäÂàóË°®
const loadAnnouncements = async (isLoadMore = false) => {
  if (isLoadMore) {
    loadingMore.value = true;
  } else {
    loading.value = true;
    offset.value = 0;
    announcements.value = [];
  }

  error.value = '';

  try {
    const { data } = await getAnnouncements({
      limit,
      offset: offset.value
    });

    // ËøáÊª§ÊéâÁΩÆÈ°∂ÂÖ¨ÂëäÔºåÂè™ÊòæÁ§∫ÈùûÁΩÆÈ°∂ÂÖ¨Âëä
    const filteredData = data.filter((announcement: Announcement) => !announcement.is_pinned);

    if (isLoadMore) {
      announcements.value.push(...filteredData);
    } else {
      announcements.value = filteredData;
    }

    // Â¶ÇÊûúËøîÂõûÁöÑÊï∞ÊçÆÂ∞ë‰∫éÈôêÂà∂Êï∞ÈáèÔºåËØ¥ÊòéÊ≤°ÊúâÊõ¥Â§ö‰∫Ü
    hasMore.value = filteredData.length === limit;
    offset.value += data.length;

  } catch (err: any) {
    error.value = err.message || 'Âä†ËΩΩÂÖ¨ÂëäÂ§±Ë¥•';
    ElMessage.error(error.value);
  } finally {
    loading.value = false;
    loadingMore.value = false;
  }
};

// Âä†ËΩΩÊõ¥Â§ö
const loadMore = () => {
  loadAnnouncements(true);
};

// Ê†ºÂºèÂåñÊó∂Èó¥
const formatTime = (timestamp: number): string => {
  const date = new Date(timestamp * 1000);
  const now = new Date();
  const diffInHours = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60));

  if (diffInHours < 1) {
    const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));
    return diffInMinutes < 1 ? 'ÂàöÂàö' : `${diffInMinutes}ÂàÜÈíüÂâç`;
  }

  if (diffInHours < 24) {
    return `${diffInHours}Â∞èÊó∂Ââç`;
  }

  if (diffInHours < 168) { // 7Â§©
    return `${Math.floor(diffInHours / 24)}Â§©Ââç`;
  }

  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÂÖ¨Âëä
onMounted(() => {
  loadAnnouncements();
});
</script>

<style scoped lang="scss">
.announcements-page {
  padding: 24px;
  background: #f5f7fa;
  min-height: 100%;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  box-sizing: border-box;

  .page-header {
    margin: 0 auto 24px;
    width: 100%;
    max-width: 1200px;


    .page-title {
      font-size: 28px;
      font-weight: 600;
      color: #303133;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
  }

  .announcements-container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    box-sizing: border-box;

    .loading-container,
    .error-container,
    .empty-container {
      background: white;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
    }

    .announcements-list {
      .announcement-item {
        background: white;
        border-radius: 8px;
        margin: 0 auto 16px;
        padding: 16px;
        box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.1);
        border-left: 3px solid transparent;
        transition: all 0.3s ease;
        width: 100%;
        box-sizing: border-box;

        &:hover {
          box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.15);
          transform: translateY(-2px);
        }

        &.announcement-type-info {
          border-left-color: #409eff;

          .announcement-icon {
            color: #409eff;
            background-color: rgba(64, 158, 255, 0.1);
          }
        }

        &.announcement-type-warning {
          border-left-color: #e6a23c;

          .announcement-icon {
            color: #e6a23c;
            background-color: rgba(230, 162, 60, 0.1);
          }
        }

        &.announcement-type-success {
          border-left-color: #67c23a;

          .announcement-icon {
            color: #67c23a;
            background-color: rgba(103, 194, 58, 0.1);
          }
        }

        &.announcement-type-danger {
          border-left-color: #f56c6c;

          .announcement-icon {
            color: #f56c6c;
            background-color: rgba(245, 108, 108, 0.1);
          }
        }

        .announcement-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 12px;

          .announcement-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;

            .announcement-icon {
              width: 32px;
              height: 32px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 16px;
              flex-shrink: 0;
            }

            .announcement-title {
              font-size: 18px;
              font-weight: 600;
              color: #303133;
              margin: 0;
              line-height: 1.4;
              flex: 1;
            }

            .pinned-tag {
              flex-shrink: 0;
            }
          }

          .announcement-meta {
            .announcement-time {
              display: flex;
              align-items: center;
              gap: 4px;
              color: #909399;
              font-size: 14px;
              white-space: nowrap;

              .el-icon {
                font-size: 16px;
              }
            }
          }
        }

        .announcement-content {
          margin-bottom: 12px;

          .content-text {
            color: #606266;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
          }

          :deep(p) {
            margin: 0 0 8px 0;
            color: #606266;
            font-size: 14px;
            line-height: 1.5;

            &:last-child {
              margin-bottom: 0;
            }
          }

          :deep(h1), :deep(h2), :deep(h3), :deep(h4), :deep(h5), :deep(h6) {
            color: #303133;
            margin: 12px 0 6px 0;

            &:first-child {
              margin-top: 0;
            }
          }

          :deep(ul), :deep(ol) {
            margin: 12px 0;
            padding-left: 24px;
            color: #606266;
          }

          :deep(code) {
            background-color: #f1f2f3;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            color: #e74c3c;
          }

          :deep(pre) {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;

            code {
              background: none;
              padding: 0;
              color: #495057;
            }
          }
        }

        .announcement-footer {
          .announcement-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;

            .author, .expires {
              font-size: 14px;
              color: #909399;
            }

            .author {
              font-weight: 500;
            }

            .expires {
              font-style: italic;
            }
          }
        }
      }
    }

    .load-more {
      text-align: center;
      padding: 20px;
    }
  }
}

// ÂìçÂ∫îÂºèËÆæËÆ°
@media (max-width: 768px) {
  .announcements-page {
    padding: 16px;
    min-height: calc(100vh - 100px);

    .page-header {
      margin-bottom: 16px;


      .page-title {
        font-size: 22px;
      }
    }

    .announcements-container {
      .loading-container,
      .error-container,
      .empty-container {
        padding: 30px 16px;
      }

      .announcements-list {
        .announcement-item {
          padding: 16px;
          margin-bottom: 12px;
          border-radius: 6px;

          .announcement-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 12px;

            .announcement-title-section {
              width: 100%;
              gap: 10px;

              .announcement-icon {
                width: 28px;
                height: 28px;
                font-size: 14px;
              }

              .announcement-title {
                font-size: 16px;
                line-height: 1.3;
              }
            }

            .announcement-meta {
              align-self: flex-start;

              .announcement-time {
                font-size: 13px;
              }
            }
          }

          .announcement-content {
            margin-bottom: 10px;

            .content-text {
              font-size: 14px;
              line-height: 1.6;
            }

            :deep(p) {
              font-size: 14px;
              line-height: 1.6;
            }
          }

          .announcement-footer {
            .announcement-info {
              gap: 12px;

              .author,
              .expires {
                font-size: 13px;
              }
            }
          }
        }
      }

      .load-more {
        padding: 16px;
      }
    }
  }
}

@media (max-width: 480px) {
  .announcements-page {
    padding: 12px;

    .page-header {
      .page-title {
        font-size: 20px;
      }
    }

    .announcements-container {
      .announcements-list {
        .announcement-item {
          padding: 12px;

          .announcement-header {
            .announcement-title-section {
              gap: 8px;

              .announcement-icon {
                width: 24px;
                height: 24px;
                font-size: 13px;
              }

              .announcement-title {
                font-size: 15px;
              }
            }

            .announcement-meta {
              .announcement-time {
                font-size: 12px;
              }
            }
          }

          .announcement-content {
            .content-text {
              font-size: 13px;
            }

            :deep(p) {
              font-size: 13px;
            }
          }

          .announcement-footer {
            .announcement-info {
              .author,
              .expires {
                font-size: 12px;
              }
            }
          }
        }
      }
    }
  }
}
</style>
